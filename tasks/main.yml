---
- name: Install apt packages
  become: True
  become_user: "{{ root_user }}"
  apt:
      name: "{{ item }}"
      state: latest
      update_cache: True
  with_items:
    - slurm-wlm
    - munge

- name: hide slurm user (created by slurm package) on login screens
  become: true
  become_user: "{{ root_user }}"
  ini_file:
    path: "/var/lib/AccountsService/users/slurm"
    section: "User"
    option: "SystemAccount"
    value: "true"

# Used configurator for generating file (use the one of the correct SLURM version!)
# https://slurm.schedmd.com/configurator.html
- name: Copy slurm configuration template
  become: True
  become_user: "{{ root_user }}"
  template:
      src: slurm.conf
      dest: /etc/slurm-llnl/slurm.conf

- name: create munge key
  become: True
  become_user: "{{ root_user }}"
  # Force overwriting old key - should not happen because of the 'creates' flag
  # below, but useful to avoid prompts
  shell: /usr/sbin/create-munge-key -f
  args:
    creates: "/etc/munge/munge.key"


- name: start services
  become: True
  become_user: "{{ root_user }}"
  service:
      name: "{{ item }}"
      state: started
  with_items:
  - slurmctld
# slurmdbd does not exist in SLURM 15.08
#  - slurmdbd
  - slurmd
  - munge


#For some reason, a permission change is needed to avoid some later warnings:
#sudo chmod g-w /var/log
#sudo chmod g-w /var/log/munge
#

