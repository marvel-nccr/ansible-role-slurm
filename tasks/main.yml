---
- name: Install apt packages
  become: true
  become_user: "{{ root_user }}"
  apt:
    name:
      - slurm-wlm
      - munge
      - sendmail
    state: present
    update_cache: true

- name: hide slurm user (created by slurm package) on login screens
  become: true
  become_user: "{{ root_user }}"
  ini_file:
    path: "/var/lib/AccountsService/users/slurm"
    section: "User"
    option: "SystemAccount"
    value: "true"

# Used configurator for generating file
# (make sure to select the correct SLURM version!)
# https://slurm.schedmd.com/configurator.html
- name: Copy slurm configuration template
  become: true
  become_user: "{{ root_user }}"
  template:
    src: slurm.conf
    owner: "{{ slurm_user }}"
    dest: /etc/slurm-llnl/slurm.conf

# munge key already created by apt-get install
# will not overwrite key due to 'creates' flag
# but useful to avoid prompts
- name: create munge key
  become: true
  become_user: "{{ root_user }}"
  command: /usr/sbin/create-munge-key -f
  args:
    creates: "/etc/munge/munge.key"

- import_tasks: hostname.yml

- name: start services
  become: true
  become_user: "{{ root_user }}"
  service:
    name: "{{ item }}"
    state: started
  with_items:
    - slurmctld
    - slurmd
    - munge
# slurmdbd does not exist in SLURM 15.08
#    - slurmdbd

- import_tasks: tests.yml
  when: run_tests is defined and run_tests
